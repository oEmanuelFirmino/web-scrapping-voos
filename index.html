<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard de Voos</title>
    <link rel="shortcut icon" href="./logo.svg" type="image/x-icon" />
    <style>
      /* ===== Tema Escuro e Minimalista ===== */
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 20px;
        background: #121212;
        color: #e0e0e0;
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #90caf9;
        font-weight: 600;
      }

      /* ===== Abas ===== */
      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #333;
        overflow-x: auto;
      }

      .tab {
        padding: 8px 18px;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
        margin-right: 5px;
        background: #1e1e1e;
        color: #aaa;
        font-weight: 500;
        transition: 0.2s;
      }

      .tab:hover {
        color: #fff;
      }

      .tab.active {
        background: #333;
        color: #fff;
        font-weight: 600;
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* ===== Headers ===== */
      h3 {
        margin-top: 20px;
        color: #fff;
        padding: 5px 12px;
        border-radius: 6px;
        display: inline-block;
        font-size: 0.95em;
      }

      h4 {
        margin-top: 15px;
        color: #90caf9;
        font-weight: 500;
        font-size: 1em;
      }

      h5.sub-slot {
        margin: 8px 0 12px 0;
        font-size: 0.85em;
        font-weight: 500;
        color: #b39ddb;
        padding-left: 6px;
        border-left: 3px solid #6d4c41;
      }

      /* ===== Tabelas ===== */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 0.9em;
        border-radius: 8px;
        overflow: hidden;
        background: #1e1e1e;
      }

      th,
      td {
        padding: 8px 12px;
        text-align: left;
      }

      th {
        background: #333;
        color: #90caf9;
        position: sticky;
        top: 0;
      }

      tbody tr:nth-child(even) {
        background: #2c2c2c;
      }

      tbody tr:hover {
        background: #3a3a3a;
      }

      .price-low {
        color: #00e676;
        font-weight: 600;
      }

      .slot-badge {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
        color: white;
      }

      .Madrugada {
        background: #6d4c41;
      }
      .Dia {
        background: #fbc02d;
        color: #000;
      }
      .Tarde {
        background: #ff9800;
      }
      .Noite {
        background: #1976d2;
      }

      #voos-container {
        max-width: 1100px;
        margin: auto;
      }
    </style>
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const SUPABASE_URL = "https://wgxvjfhfohypcyyyidkz.supabase.co"; // TODO: trocar
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndneHZqZmhmb2h5cGN5eXlpZGt6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjUwMzQxNywiZXhwIjoyMDcyMDc5NDE3fQ.wbLhw8cLrvqhEUU4MdDRYNkRTSXplBBu5Gkqx-813DM"; // TODO: trocar
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      function getTimeSlot(queryTime) {
        const hour = new Date(queryTime).getHours();
        if (hour >= 0 && hour < 6) {
          if (hour < 2) return "Madrugada_00_02";
          if (hour < 4) return "Madrugada_02_04";
          return "Madrugada_04_06";
        }
        if (hour >= 6 && hour < 12) return "Dia";
        if (hour >= 12 && hour < 18) return "Tarde";
        return "Noite";
      }

      function slotLabel(slot) {
        if (slot === "Madrugada_00_02") return "Madrugada (00h–02h)";
        if (slot === "Madrugada_02_04") return "Madrugada (02h–04h)";
        if (slot === "Madrugada_04_06") return "Madrugada (04h–06h)";
        return slot;
      }

      async function fetchVoos() {
        const { data: voos, error } = await supabase.from("voos").select("*");
        if (error) {
          console.error("Erro ao buscar voos:", error);
          return [];
        }
        return voos;
      }

      function groupVoos(voos) {
        const grouped = {};
        voos.forEach((r) => {
          const day = new Date(r.query_time).toISOString().split("T")[0];
          const slot = getTimeSlot(r.query_time);
          const airline =
            r.raw_data?.itineraries?.[0]?.segments?.[0]?.operating
              ?.carrierName ||
            r.airline ||
            "Desconhecida";

          if (!grouped[day]) grouped[day] = {};
          if (!grouped[day][slot]) grouped[day][slot] = {};
          if (!grouped[day][slot][airline]) grouped[day][slot][airline] = [];

          grouped[day][slot][airline].push(r);
        });

        for (const day in grouped) {
          for (const slot in grouped[day]) {
            for (const airline in grouped[day][slot]) {
              grouped[day][slot][airline].sort(
                (a, b) => a.price_brl - b.price_brl
              );
            }
          }
        }

        return grouped;
      }

      function renderTabs(grouped) {
        const container = document.getElementById("voos-container");
        container.innerHTML = "";

        const tabsDiv = document.createElement("div");
        tabsDiv.classList.add("tabs");
        const tabContentsDiv = document.createElement("div");

        const days = Object.keys(grouped).sort();
        days.forEach((day, index) => {
          const tab = document.createElement("div");
          tab.classList.add("tab");
          if (index === 0) tab.classList.add("active");
          tab.textContent = day;
          tab.onclick = () => {
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));
            contentDiv.classList.add("active");
          };
          tabsDiv.appendChild(tab);

          const contentDiv = document.createElement("div");
          contentDiv.classList.add("tab-content");
          if (index === 0) contentDiv.classList.add("active");

          const slots = grouped[day];
          for (const slot of Object.keys(slots).sort()) {
            const slotHeader = document.createElement("h3");
            slotHeader.textContent = slotLabel(slot).split(" ")[0];
            slotHeader.classList.add(
              "slot-badge",
              slot.includes("Madrugada") ? "Madrugada" : slot
            );
            contentDiv.appendChild(slotHeader);

            if (slot.includes("Madrugada")) {
              const subHeader = document.createElement("h5");
              subHeader.textContent = slotLabel(slot);
              subHeader.classList.add("sub-slot");
              contentDiv.appendChild(subHeader);
            }

            const airlines = slots[slot];
            for (const airline of Object.keys(airlines).sort()) {
              const flights = airlines[airline];

              const airlineHeader = document.createElement("h4");
              airlineHeader.textContent = `Companhia: ${
                airline == "G3" ? "GOL" : airline
              }`;
              contentDiv.appendChild(airlineHeader);

              const table = document.createElement("table");
              const thead = document.createElement("thead");
              thead.innerHTML = `
                <tr>
                  <th>Origem</th>
                  <th>Destino</th>
                  <th>Partida</th>
                  <th>Retorno</th>
                  <th>Preço (BRL)</th>
                  <th>Hora da Query</th>
                </tr>`;
              table.appendChild(thead);

              const tbody = document.createElement("tbody");
              flights.forEach((f, idx) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${f.origin}</td>
                  <td>${f.destination}</td>
                  <td>${f.departure}</td>
                  <td>${f.return}</td>
                  <td class="${
                    idx === 0 ? "price-low" : ""
                  }">${f.price_brl.toFixed(2)}</td>
                  <td>${new Date(f.query_time).toLocaleString("pt-BR")}</td>
                `;
                tbody.appendChild(row);
              });
              table.appendChild(tbody);
              contentDiv.appendChild(table);
            }
          }

          tabContentsDiv.appendChild(contentDiv);
        });

        container.appendChild(tabsDiv);
        container.appendChild(tabContentsDiv);
      }

      async function init() {
        const voos = await fetchVoos();
        const grouped = groupVoos(voos);
        renderTabs(grouped);
      }

      window.addEventListener("DOMContentLoaded", init);
    </script>
  </head>
  <body>
    <h1>Dashboard de Voos</h1>
    <div id="voos-container"></div>
  </body>
</html>
